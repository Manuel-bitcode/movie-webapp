name: CI/CD Pipeline

# Eventos que disparan el workflow
on:
  push:
    branches:
      - main
      - feat/**
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      branch:
        description: 'Rama a construir'
        required: true
        default: 'main'
        type: string

# Variables de entorno globales
env:
  NODE_VERSION: '20'
  APP_PORT: '3002'

jobs:
  build-and-test:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    
    steps:
      # âœ… Verificar Herramientas (implÃ­cito en setup-node)
      - name: âœ… Verificar Herramientas
        run: |
          echo "ğŸ”§ Verificando herramientas disponibles..."
          echo "Node.js version:"
          node --version
          echo "npm version:"
          npm --version
      
      # ğŸ” Checkout
      - name: ğŸ” Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      
      # Configurar Node.js
      - name: âš™ï¸ Configurar Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # ğŸ“¦ Instalar Dependencias
      - name: ğŸ“¦ Instalar Dependencias
        run: |
          echo "ğŸ“¦ Instalando dependencias de Node.js..."
          npm install
      
      # ğŸ” Lint (Revisar cÃ³digo)
      - name: ğŸ” Lint (Revisar cÃ³digo)
        run: |
          echo "ğŸ” Analizando cÃ³digo con ESLint..."
          npm run lint || echo "âš ï¸  Lint encontrÃ³ advertencias"
        continue-on-error: true
      
      # ğŸ§ª Tests con Vitest
      - name: ğŸ§ª Tests con Vitest
        run: |
          echo "ğŸ§ª Ejecutando tests unitarios..."
          npm test
      
      # ğŸ—ï¸ Build Next.js
      - name: ğŸ—ï¸ Build Next.js
        run: |
          echo "ğŸ—ï¸ Compilando aplicaciÃ³n Next.js..."
          npm run build
      
      # Guardar artefactos del build
      - name: ğŸ“¤ Guardar artefactos del build
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: nextjs-build
          path: |
            .next/
            !.next/cache/
          retention-days: 7
      
      # Resumen final
      - name: ğŸ Pipeline finalizado
        if: always()
        run: echo "ğŸ Pipeline finalizado."
      
      - name: âœ… Build exitoso
        if: success()
        run: echo "âœ… Â¡Build exitoso! Todo funcionÃ³ correctamente."
      
      - name: âŒ Build fallÃ³
        if: failure()
        run: |
          echo "âŒ Build fallÃ³. Revisa los logs arriba."
          exit 1

