version: '3.8'

services:
  app:
    # Nombre personalizado del contenedor (más fácil de identificar en logs)
    container_name: movie-webapp
    
    # Configuración de construcción de la imagen
    build: 
      context: .              # Directorio desde donde se construye
      dockerfile: Dockerfile  # Archivo que define la imagen
    
    # Mapeo de puertos: puerto_host:puerto_contenedor
    ports:
      - "3002:3000"

    networks:
      movie-network:
        aliases:
          - movie-webapp
    
    # Volúmenes para sincronizar archivos entre host y contenedor
    volumes:
      - .:/app                # Sincroniza todo el proyecto con /app en el contenedor
      - /app/node_modules     # Evita sobrescribir node_modules del contenedor
      - /app/.next            # Mantiene caché de Next.js separada
    
    # Variables de entorno
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:3000
      - NODE_ENV=development      # Define el entorno como desarrollo
      - WATCHPACK_POLLING=true    # Habilita hot-reload en Docker (detecta cambios de archivos)
    
    # Política de reinicio: se reinicia automáticamente excepto cuando se detiene manualmente
    restart: unless-stopped
    
    # Permite mantener STDIN abierto (útil para debugging)
    stdin_open: true
    
    # Asigna una pseudo-TTY (terminal interactiva)
    tty: true

  jenkins:
    # Nombre del contenedor de Jenkins
    container_name: jenkins-server
    
    # Imagen oficial de Jenkins LTS (Long Term Support)
    image: jenkins/jenkins:lts
    
    # Ejecutar como usuario root para evitar problemas de permisos
    user: root
    
    # Mapeo de puertos
    ports:
      - "8080:8080"   # Puerto web de Jenkins
      - "50000:50000" # Puerto para agentes Jenkins
    
    networks:
      movie-network:
        aliases:
          - jenkins-server
    
    # Volúmenes para persistencia de datos
    volumes:
      - jenkins_home:/var/jenkins_home              # Datos de Jenkins (jobs, configuración, etc)
      - /var/run/docker.sock:/var/run/docker.sock   # Socket de Docker (para Docker-in-Docker)
      - .:/workspace/movie-webapp                   # Acceso al código del proyecto (solo lectura recomendado)
    
    # Variables de entorno
    environment:
      - JENKINS_OPTS=--prefix=/jenkins  # Opcional: si quieres acceder via /jenkins
    
    # Política de reinicio
    restart: unless-stopped

networks:
  movie-network:
    external: true

volumes:
  jenkins_home:
    driver: local